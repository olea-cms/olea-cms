doctype html
html.h-full.min-h-full
  head
    meta(charset='UTF-8')
    link(rel='icon' type='image/svg+xml' href='/public/logo-circle-wrap-text.png')
    link(rel="stylesheet" href="/public/stylesheet.css")
    meta(name='viewport' content='width=device-width, initial-scale=1.0')
    title #{process.env.OLEA_TITLE || "OleaCMS"}
    script(src="https://unpkg.com/htmx.org@2.0.1/dist/htmx.js" integrity="sha384-gpIh5aLQ0qmX8kZdyhsd6jA24uKLkqIr1WAGtantR4KsS97l/NRBvh8/8OYGThAf" crossorigin="anonymous")
    script(src='https://unpkg.com/htmx-ext-alpine-morph@2.0.0/alpine-morph.js')
    script(defer src="https://unpkg.com/@alpinejs/morph@3.x.x/dist/cdn.min.js")
    script(src='https://unpkg.com/htmx-ext-response-targets@2.0.0/response-targets.js')
    script(src="https://unpkg.com/htmx-ext-loading-states@2.0.0/loading-states.js")
    script(src='https://cdn.jsdelivr.net/npm/pinecone-router@4.x.x/dist/router.min.js')
    script(src='https://unpkg.com/nprogress@0.2.0/nprogress.js')
    //- link(rel='stylesheet' href='https://unpkg.com/nprogress@0.2.0/nprogress.css')
    link(rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css")
    script(type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js")
    script.
      // alpine config
      document.addEventListener('alpine:init', () => {
        window.PineconeRouter.settings.hash = false // use hash routing
        window.PineconeRouter.settings.basePath = '/' // set the base for the URL, doesn't work with hash routing
        window.PineconeRouter.settings.templateTargetId = 'app' // Set an optional ID for where the internal & external templates will render by default.
        window.PineconeRouter.settings.interceptLinks = true // Set to false to disable global handling of links by the router, see Disable link handling globally for more.
      });
      document.addEventListener('pinecone-start', ({ target }) => {
        NProgress.start();
        if (PineconeRouter.context.path === target.location.pathname) {
          NProgress.done();
        }
      });
      document.addEventListener('pinecone-end', () => {NProgress.done()});
      document.addEventListener('fetch-error', (err) => console.error(err));
      // enable swapping into the catastrophicError element when
      // response codes are 5xx
      document.addEventListener('htmx:beforeSwap', ({ detail }) => {
        if (detail.xhr.status === 500 && detail.target.id === 'catastrophicError') {
          detail.shouldSwap = true;
        }
      });

      // Helper function to get cookies
      function getCookie(name) {
          const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
          if (match) {
            console.log({match});
            return match[2];
          }
          return null;
      }

      const router = () => ({
        authHandler(context) {
          // Check for jwt in cookies
          const jwt = getCookie('auth');
          if (!jwt && !['/login', '/register'].includes(context.path)) {
            context.redirect('/');
            return 'stop';
          }
          if (['/login', '/register'].includes(context.path)) {
            context.redirect('/admin');
          }
        }
      });
    script.
      (function() {
        // Set global variable based on cookie existence
        window.isAuthed = !!getCookie('auth');
        // Remove this script from the document >:-)
        const scriptElement = document.currentScript;
        if (scriptElement && scriptElement.parentNode) {
          scriptElement.parentNode.removeChild(scriptElement);
        }
      })();
    script(src='https://unpkg.com/alpinejs-component@latest/dist/component.min.js' defer='')
    script(defer='' src='https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js')

    include common/mixins
    //- https://stackoverflow.com/questions/45824697/workaround-to-dynamic-includes-in-pug-jade
    //- adynamicInclude is included as a variable in every call of
    //- renderPug and renderPugFile, see libs/renderPug.ts and
    //- libs/dynamicPugInclude.ts
    //- also I just wanna say this is really based
    mixin heroicon(iconName, opts = { size: 6, fill: 'currentColor' })
      .pug-hero-icon&attributes(attributes)
        | !{dynamicInclude(`components/icons/${iconName}.pug`, { size: opts.size || 6, fill: opts.fill || 'currentColor'})}

    //- this sucks booty but I have to do it to precompile all the sizes I
    //- want, probably will have to do it for fill colors as well
    .hidden.size-1.size-2.size-3.size-4.size-5.size-6.size-7.size-8.size-9.size-10.size-12.size-14.size-16.size-18.size-20.size-24.size-28.size-32.size-40.size-42


  // we have to set x-data for pinecone router
  body.bg-base-200.h-full.min-h-full(x-data='router()' hx-ext='loading-states, alpine-morph' hx-swap='morph')
    #catastrophicError
    include components/navbar
    include components/admin-navbar

    #app(class='h-[calc(100vh-64px)] min-h-[calc(100vh-64px)]')
    // #app(class='h-full min-h-full')

    // routes
    template(x-route='/admin' x-template='/admin/template')
    include pages/home
    include pages/login
    include pages/register
    template(x-route='notfound')
      .hero.bg-base-100.min-h-screen(x-data='{ count: 0 }')
        +htmx
        .hero-content.flex-col
          div
            h1.text-5xl.font-bold 404: Page not found
            p.py-6 Uh oh! Looks like you tried visiting a page that doesn't exist.
          .flex.justify-between.w-full.divide-x
            div
              h3 Alpine demo:
              span(x-text='count')
              .flex.content-between.mt-4.gap-2
                button.btn.btn-primary(x-on:click='count--') Decrement
                button.btn.btn-secondary(x-on:click='count++') Increment
            .pl-16
              h3 HTMX demo:
              button.btn.btn-primary(hx-get='/ping' hx-target='#pong') Ping
              p#pong
          a.btn.btn-secondary.mt-6(href='/') Go home
